---
- name: Find Firefox profiles parent directories
  ansible.builtin.stat:
    path: "{{ item }}"
  loop:
    - "{{ home_dir }}/Library/Application Support/Firefox/Profiles"
    - "{{ home_dir }}/.mozilla/firefox"
  register: firefox_profiles_dir_stats

- name: Find Firefox profiles
  ansible.builtin.find:
    paths: "{{ firefox_profiles_dir_stats.results | selectattr('stat.isdir', 'defined') | selectattr('stat.isdir') | map(attribute='item') | list }}"
    file_type: directory
    patterns: "*.*"
  register: firefox_profiles

- name: Set Firefox profile path
  ansible.builtin.set_fact:
    firefox_profile_path: "{{ firefox_profiles.files[0].path if (firefox_profiles.files | length == 1) else \"\" }}"

- name: Warn if multiple Firefox profiles found
  ansible.builtin.fail:
    msg: "warning: too many Firefox profiles; ignoring Firefox"
  when: firefox_profiles.files | length > 1
  ignore_errors: true

- name: Warn if no Firefox profiles found
  ansible.builtin.fail:
    msg: "warning: could not find any Firefox profiles; ignoring Firefox"
  when: firefox_profiles.files | length == 0
  ignore_errors: true

- name: Ensure Firefox chrome directory exists
  ansible.builtin.file:
    path: "{{ firefox_profile_path }}/chrome"
    state: directory
    mode: "0755"
  when: firefox_profile_path != ""

- name: Symlink userChrome.css
  ansible.builtin.file:
    src: "{{ dotfiles_dir }}/firefox/userChrome.css"
    dest: "{{ firefox_profile_path }}/chrome/userChrome.css"
    state: link
    force: false
  when: firefox_profile_path != ""

- name: Symlink userContent.css
  ansible.builtin.file:
    src: "{{ dotfiles_dir }}/firefox/userContent.css"
    dest: "{{ firefox_profile_path }}/chrome/userContent.css"
    state: link
    force: false
  when: firefox_profile_path != ""
